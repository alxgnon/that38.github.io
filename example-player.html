<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>that72.org Player Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .player {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        button {
            padding: 10px 20px;
            background: #4a9eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #357abd;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        input[type="range"] {
            width: 200px;
        }
        
        .info {
            margin-top: 10px;
        }
        
        .track-list {
            margin-top: 20px;
        }
        
        .track {
            padding: 5px 10px;
            background: #1a1a1a;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .track button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .playing-notes {
            margin-top: 20px;
            min-height: 50px;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
        }
        
        .note-indicator {
            display: inline-block;
            padding: 2px 8px;
            background: #4a9eff;
            color: white;
            border-radius: 3px;
            margin: 2px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>that72.org Player Example</h1>
    
    <div class="player">
        <div class="controls">
            <button id="playBtn">Play</button>
            <button id="stopBtn">Stop</button>
            <label>
                Volume: 
                <input type="range" id="volumeSlider" min="0" max="100" value="30">
                <span id="volumeValue">30</span>
            </label>
            <label>
                <input type="checkbox" id="loopCheckbox"> Loop
            </label>
        </div>
        
        <div class="info">
            <div>Status: <span id="status">Stopped</span></div>
            <div>Measure: <span id="measure">0</span></div>
            <div>Tempo: <span id="tempo">120</span> BPM</div>
        </div>
        
        <div class="track-list" id="trackList">
            <h3>Tracks:</h3>
        </div>
        
        <div class="playing-notes">
            <h3>Playing Notes:</h3>
            <div id="playingNotes"></div>
        </div>
    </div>
    
    <div>
        <h3>Load a Song:</h3>
        <input type="file" id="fileInput" accept=".json">
        <p>Or try the demo song: <button id="loadDemoBtn">Load Demo Song</button></p>
    </div>

    <script type="module">
        import PlaybackEngine from './js/PlaybackEngine.js';
        
        // Demo song data
        const demoSong = {
            version: "1.1",
            name: "Demo Song",
            tempo: 120,
            timeSignature: "4/4",
            loop: {
                enabled: true,
                startMeasure: 0,
                endMeasure: 4
            },
            notes: [
                // C major scale
                { pitch: 60, measure: 0, beat: 0, duration: 4, velocity: 100, pan: 0, instrument: "ORG_M00" },
                { pitch: 62, measure: 0, beat: 4, duration: 4, velocity: 90, pan: 0, instrument: "ORG_M00" },
                { pitch: 64, measure: 0, beat: 8, duration: 4, velocity: 100, pan: 0, instrument: "ORG_M00" },
                { pitch: 65, measure: 0, beat: 12, duration: 4, velocity: 90, pan: 0, instrument: "ORG_M00" },
                
                { pitch: 67, measure: 1, beat: 0, duration: 4, velocity: 100, pan: 0, instrument: "ORG_M00" },
                { pitch: 69, measure: 1, beat: 4, duration: 4, velocity: 90, pan: 0, instrument: "ORG_M00" },
                { pitch: 71, measure: 1, beat: 8, duration: 4, velocity: 100, pan: 0, instrument: "ORG_M00" },
                { pitch: 72, measure: 1, beat: 12, duration: 4, velocity: 90, pan: 0, instrument: "ORG_M00" },
                
                // Bass line
                { pitch: 48, measure: 0, beat: 0, duration: 8, velocity: 80, pan: -50, instrument: "ORG_M01" },
                { pitch: 48, measure: 0, beat: 8, duration: 8, velocity: 80, pan: -50, instrument: "ORG_M01" },
                { pitch: 48, measure: 1, beat: 0, duration: 8, velocity: 80, pan: -50, instrument: "ORG_M01" },
                { pitch: 48, measure: 1, beat: 8, duration: 8, velocity: 80, pan: -50, instrument: "ORG_M01" },
                
                // Chords
                { pitch: 60, measure: 2, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" },
                { pitch: 64, measure: 2, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" },
                { pitch: 67, measure: 2, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" },
                
                { pitch: 59, measure: 3, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" },
                { pitch: 62, measure: 3, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" },
                { pitch: 67, measure: 3, beat: 0, duration: 16, velocity: 70, pan: 50, instrument: "ORG_M02" }
            ]
        };
        
        // Initialize player
        const player = new PlaybackEngine({
            wavetablePath: './wavetable.bin',
            onNoteStart: (note) => {
                const noteEl = document.createElement('span');
                noteEl.className = 'note-indicator';
                noteEl.textContent = `${note.instrument} - Key ${note.key}`;
                noteEl.dataset.noteId = `${note.x}-${note.y}`;
                document.getElementById('playingNotes').appendChild(noteEl);
            },
            onNoteEnd: (note) => {
                const noteId = `${note.x}-${note.y}`;
                const noteEl = document.querySelector(`[data-note-id="${noteId}"]`);
                if (noteEl) {
                    noteEl.remove();
                }
            },
            onMeasureChange: (measure) => {
                document.getElementById('measure').textContent = measure;
            },
            onStop: () => {
                document.getElementById('status').textContent = 'Stopped';
                document.getElementById('playingNotes').innerHTML = '';
                playBtn.textContent = 'Play';
            }
        });
        
        // UI elements
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const loopCheckbox = document.getElementById('loopCheckbox');
        const fileInput = document.getElementById('fileInput');
        const loadDemoBtn = document.getElementById('loadDemoBtn');
        const trackList = document.getElementById('trackList');
        
        // Initialize
        player.init().then(() => {
            console.log('Player initialized');
            loadSong(demoSong);
        });
        
        // Load song
        function loadSong(songData) {
            player.stop();
            player.loadSong(songData);
            
            // Update UI
            document.getElementById('tempo').textContent = songData.tempo;
            loopCheckbox.checked = songData.loop?.enabled || false;
            
            // Update track list
            const tracks = player.getTracks();
            trackList.innerHTML = '<h3>Tracks:</h3>';
            tracks.forEach(track => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track';
                trackEl.innerHTML = `
                    <span>${track.name} (${track.noteCount} notes)</span>
                    <button data-track="${track.name}">Hide</button>
                `;
                trackList.appendChild(trackEl);
            });
            
            // Add track visibility handlers
            trackList.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const trackName = e.target.dataset.track;
                    const isHidden = e.target.textContent === 'Show';
                    player.setTrackVisibility(trackName, isHidden);
                    e.target.textContent = isHidden ? 'Hide' : 'Show';
                });
            });
        }
        
        // Controls
        playBtn.addEventListener('click', () => {
            if (player.isPlaying) {
                player.pause();
                playBtn.textContent = 'Play';
                document.getElementById('status').textContent = 'Paused';
            } else {
                player.play();
                playBtn.textContent = 'Pause';
                document.getElementById('status').textContent = 'Playing';
            }
        });
        
        stopBtn.addEventListener('click', () => {
            player.stop();
        });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            player.setVolume(volume);
            volumeValue.textContent = volume;
        });
        
        loopCheckbox.addEventListener('change', (e) => {
            player.setLoop(e.target.checked);
        });
        
        // File loading
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const songData = JSON.parse(e.target.result);
                        loadSong(songData);
                    } catch (error) {
                        alert('Invalid JSON file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });
        
        loadDemoBtn.addEventListener('click', () => {
            loadSong(demoSong);
        });
    </script>
</body>
</html>