<!DOCTYPE html>
<html>
<head>
    <title>Playback Debug</title>
    <script type="module">
        import { AudioEngine } from './js/AudioEngine.js';
        
        window.testRapidNotes = async function() {
            const audioEngine = new AudioEngine();
            await audioEngine.loadWavetable();
            
            // Test rapid note repetitions on same pitch
            const key = 48; // Middle C
            const velocity = 100;
            const instrument = 'ORG_M26'; // Instrument used in Wanpaku
            const noteDuration = 0.125; // 1/8 second (fast rhythm)
            
            console.log('=== Testing Rapid Note Repetitions ===');
            
            // Schedule 8 rapid notes on same pitch
            const startTime = audioEngine.audioContext.currentTime + 0.1;
            
            for (let i = 0; i < 8; i++) {
                const noteStartTime = startTime + (i * noteDuration);
                console.log(`Note ${i}: start=${noteStartTime.toFixed(3)}s, duration=${noteDuration}s`);
                
                // This simulates what PianoRoll.scheduleNoteAtTime does
                audioEngine.playNote(
                    key,
                    velocity,
                    instrument,
                    false, // isGlissando
                    0,     // pan
                    noteStartTime,
                    noteDuration,
                    false  // pipi
                );
            }
        };
        
        window.testOverlappingNotes = async function() {
            const audioEngine = new AudioEngine();
            await audioEngine.loadWavetable();
            
            const key = 48;
            const velocity = 100;
            const instrument = 'ORG_M26';
            
            console.log('=== Testing Overlapping Notes ===');
            
            const startTime = audioEngine.audioContext.currentTime + 0.1;
            
            // Test overlapping notes (note starts before previous ends)
            for (let i = 0; i < 4; i++) {
                const noteStartTime = startTime + (i * 0.1); // 100ms spacing
                const noteDuration = 0.2; // 200ms duration (overlaps)
                
                console.log(`Overlapping note ${i}: start=${noteStartTime.toFixed(3)}s, duration=${noteDuration}s`);
                
                audioEngine.playNote(
                    key,
                    velocity,
                    instrument,
                    false,
                    0,
                    noteStartTime,
                    noteDuration,
                    false
                );
            }
        };
        
        window.analyzeActiveNotes = function() {
            if (window.audioEngine) {
                console.log('Active notes:', window.audioEngine.activeNotes);
            }
        };
    </script>
</head>
<body>
    <h1>Playback Debug Console</h1>
    <p>Open browser console and run:</p>
    <ul>
        <li><code>testRapidNotes()</code> - Test rapid note repetitions</li>
        <li><code>testOverlappingNotes()</code> - Test overlapping notes</li>
        <li><code>analyzeActiveNotes()</code> - Check active notes map</li>
    </ul>
</body>
</html>